<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Statistik - Timo's Barista Bar</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="assets/img/icon.png">
    <meta name="theme-color" content="#2c1e16">
    <meta name="view-transition" content="same-origin">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="assets/js/menu.js"></script>

    <link rel="stylesheet" href="assets/css/style.css">
    
    <style>
        /* ZUS√ÑTZLICHE STYLES F√úR CHARTS */
        .stats-grid { display: grid; grid-template-columns: 1fr; gap: 20px; margin-bottom: 40px; }
        
        .chart-card {
            background: rgba(30, 20, 15, 0.6);
            border: 1px solid rgba(212, 180, 131, 0.2);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            backdrop-filter: blur(10px);
            margin-bottom: 25px;
        }

        .money-saved { color: #10b981; text-shadow: 0 0 15px rgba(16, 185, 129, 0.4); }

        /* Canvas responsive machen */
        canvas { max-width: 100%; height: auto; }

        /* Container Anpassung */
        .container { max-width: 600px; margin: 0 auto; padding: 0 20px 80px 20px; }

        /* Badge Styles (aus deinem Code √ºbernommen) */
        .my-stats-card { background: linear-gradient(145deg, rgba(212, 180, 131, 0.2), rgba(44, 30, 22, 0.8)); border: 1px solid #d4b483; border-radius: 15px; padding: 20px; text-align: center; margin-bottom: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .big-number { font-size: 3.5rem; font-weight: bold; color: #fff; text-shadow: 0 0 10px rgba(212, 180, 131, 0.5); display: block; margin: 10px 0; }
        .stat-label { text-transform: uppercase; letter-spacing: 2px; font-size: 0.8rem; color: #d4b483; }
        .badges-grid { display: flex; justify-content: center; gap: 15px; margin-top: 15px; flex-wrap: wrap; }
        .badge { background: rgba(0,0,0,0.4); border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; border: 2px solid #555; opacity: 0.4; filter: grayscale(100%); transition: all 0.5s; position: relative; }
        .badge.unlocked { opacity: 1; filter: grayscale(0%); border-color: #d4b483; box-shadow: 0 0 15px rgba(212, 180, 131, 0.4); }
        .badge-tooltip { display: none; position: absolute; bottom: -30px; left: 50%; transform: translateX(-50%); background: #2c1e16; padding: 5px 10px; border-radius: 5px; font-size: 0.7rem; white-space: nowrap; border: 1px solid #d4b483; z-index: 10; }
        .badge:hover .badge-tooltip { display: block; }
        
        /* Leaderboard Styles */
        .leaderboard { background: rgba(255, 255, 255, 0.05); border-radius: 15px; padding: 15px; border: 1px solid rgba(255,255,255,0.1); }
        .rank-row { display: flex; align-items: center; padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .rank-row:last-child { border-bottom: none; }
        .rank-num { width: 30px; font-weight: bold; color: #d4b483; font-size: 1.1rem; }
        .rank-name { flex: 1; font-size: 1rem; color: #fff; }
        .rank-count { background: #d4b483; color: #2c1e16; padding: 4px 10px; border-radius: 15px; font-weight: bold; font-size: 0.85rem; }
        .rank-row:nth-child(1) .rank-num { color: #FFD700; text-shadow: 0 0 10px #FFD700; font-size: 1.4rem; } 
        .rank-row:nth-child(2) .rank-num { color: #C0C0C0; } 
        .rank-row:nth-child(3) .rank-num { color: #CD7F32; } 
        .section-title { color: #d4b483; text-transform: uppercase; letter-spacing: 2px; font-size: 0.9rem; margin-bottom: 15px; text-align: center; border-bottom: 1px solid rgba(212, 180, 131, 0.3); padding-bottom: 10px; }
    </style>
</head>
<body>
    <div class="aurora-blob blob-1"></div>
    <div class="aurora-blob blob-2"></div>
    <div class="aurora-blob blob-3"></div>

    <div class="hamburger-btn" onclick="toggleMenu(event)">‚ò∞</div>

<div id="main-dropdown" class="dropdown-menu">
    <a href="stats.html" class="menu-item">
        <span>üèÜ</span> Stats & Wrapped
    </a>
    <a href="preise.html" class="menu-item">
        <span>üí∞</span> Preisliste
    </a>
    <a href="feedback.html" class="menu-item">
        <span>üí¨</span> G√§stebuch
    </a>

    <div class="menu-divider"></div>

    <a href="javascript:checkAdminAccess()" class="menu-item">
        <span>üë®‚Äçüç≥</span> Admin
    </a>
    <a href="javascript:logout()" class="menu-item" style="color: #fca5a5;">
        <span>üö™</span> Logout
    </a>
</div>
    
    <h1>Dein Coffee</h1>
    <div class="subtitle">Wrapped & Stats üìä</div>

    <nav class="navbar">
        <a href="app.html" class="nav-link">Bestellen</a>
        <a href="maschine.html" class="nav-link">Maschine</a>
        <a href="bohnen.html" class="nav-link">Bohnen</a>
        <a href="glaeser.html" class="nav-link">Gl√§ser</a>
        <a href="stats.html" class="nav-link active">Stats üèÜ</a>
    </nav>

    <div class="container">
        
        <div class="chart-card scroll-reveal" style="text-align:center;">
            <div class="stat-label">Gespart gegen√ºber Caf√©s</div>
            <div id="total-saved" class="big-number money-saved">0,00 ‚Ç¨</div>
            <div style="font-size: 0.8rem; color: #888;">Gerechnet mit den Preisen aus der Preisliste (siehe weiter unten)</div>
        </div>

        <div class="chart-card scroll-reveal" style="text-align:center; border-color: #f48fb1;">
            <div class="stat-label" style="color: #f48fb1;">Gesammeltes Trinkgeld</div>
            <div id="tip-amount" class="big-number" style="color: #fce4ec; text-shadow: 0 0 10px #ec407a;">0,00 ‚Ç¨</div>
            <div style="font-size: 0.8rem; color: #888;">(Basierend auf 0,50‚Ç¨ pro M√ºnze)</div>
        </div>

        <div class="chart-card scroll-reveal">
            <div class="stat-label" style="text-align:center; margin-bottom:15px;">Deine Favoriten</div>
            <canvas id="typeChart"></canvas>
        </div>

        <div class="chart-card scroll-reveal">
            <div class="stat-label" style="text-align:center; margin-bottom:15px;">Wann trinkst du? (Uhrzeit)</div>
            <canvas id="timeChart"></canvas>
        </div>

        <div class="section-title" style="margin-top: 40px;">Deine Erfolge</div>
        <div class="my-stats-card scroll-reveal">
            <span class="stat-label">Gesamt-Pegel</span>
            <span id="my-count" class="big-number">0</span>
            <span class="stat-label">Getrunkene Tassen</span>

            <div class="badges-grid">
                <div class="badge" id="badge-1">üë∂<div class="badge-tooltip">Erste Tasse (1)</div></div>
                <div class="badge" id="badge-10">üöÄ<div class="badge-tooltip">Stammkunde (10)</div></div>
                <div class="badge" id="badge-50">‚òï<div class="badge-tooltip">Koffein-Junkie (50)</div></div>
                <div class="badge" id="badge-100">üëë<div class="badge-tooltip">Barista King (100)</div></div>
            </div>
        </div>

        <div class="section-title">Hall of Fame</div>
        <div id="leaderboard-list" class="leaderboard scroll-reveal">
            <div style="text-align:center; padding:20px; color:#888;">Lade Daten...</div>
        </div>

        <a href="preise.html" class="price-link-btn scroll-reveal">
            üí∞ Preisliste ansehen
        </a>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, get, set, push } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyCy8RnpwpL0RdjfaU690j7mKAzr1fiWFXk",
            authDomain: "timos-barista-bar.firebaseapp.com",
            databaseURL: "https://timos-barista-bar-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "timos-barista-bar",
            storageBucket: "timos-barista-bar.firebasestorage.app",
            messagingSenderId: "94308664114",
            appId: "1:94308664114:web:13ace1464e7b3db9054d2b"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);

        // Chart.js Styles
        if (typeof Chart !== 'undefined') {
            Chart.defaults.color = '#a09085';
            Chart.defaults.borderColor = 'rgba(212, 180, 131, 0.1)';
            Chart.defaults.font.family = '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto';
        }

        // ============================================
        // 1. ANIMATION STARTEN (WICHTIG: ZUERST!) üèÅ
        // ============================================
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => { if(entry.isIntersecting) entry.target.classList.add('visible'); });
        });
        document.querySelectorAll('.scroll-reveal').forEach(el => observer.observe(el));


        // ============================================
        // 2. DATEN LADEN üì°
        // ============================================
        let currentUser = null;

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                loadLeaderboard(); // Globales Ranking
                loadPersonalWrapped(user.uid); // Pers√∂nliche Charts
                loadTips(); // Trinkgeld laden
            } else {
                window.location.href = "login.html";
            }
        });

        // TRINKGELD LADEN
        function loadTips() {
            const tipRef = ref(db, 'stats/totalTips');
            onValue(tipRef, (snapshot) => {
                const coins = snapshot.val() || 0;
                const wertProMuenze = 0.50; 
                const totalEuro = (coins * wertProMuenze).toFixed(2).replace('.', ',');
                
                const el = document.getElementById('tip-amount');
                if(el) el.innerText = totalEuro + " ‚Ç¨";
            });
        }

        // PERS√ñNLICHE CHARTS (History)
        function loadPersonalWrapped(uid) {
            const historyRef = ref(db, `users/${uid}/history`);
            
            onValue(historyRef, (snapshot) => {
                const data = snapshot.val();
                
                if (!data) {
                    const el = document.getElementById('total-saved');
                    if(el) el.innerText = "0,00 ‚Ç¨";
                    return;
                }

                const orders = Object.values(data);
                
                // A) GELD
                let totalMoney = 0;
                orders.forEach(o => totalMoney += (o.saved || 4.50));
                const elSaved = document.getElementById('total-saved');
                if(elSaved) elSaved.innerText = totalMoney.toFixed(2).replace('.', ',') + " ‚Ç¨";

                // B) PIE CHART
                const typeCounts = {};
                orders.forEach(o => {
                    const type = o.product || "Kaffee";
                    typeCounts[type] = (typeCounts[type] || 0) + 1;
                });
                renderPieChart(typeCounts);

                // C) LINE CHART
                const hourCounts = new Array(24).fill(0);
                orders.forEach(o => {
                    if(o.timestamp) {
                        const hour = new Date(o.timestamp).getHours();
                        hourCounts[hour]++;
                    }
                });
                renderTimeChart(hourCounts);
            });
        }

        // LEADERBOARD & BADGES
        function loadLeaderboard() {
            const ordersRef = ref(db, 'orders');
            onValue(ordersRef, (snapshot) => {
                const data = snapshot.val();
                if (!data) return;

                const orders = Object.values(data);
                const userCounts = {};

                orders.forEach(order => {
                    const name = order.user || "Unbekannt";
                    userCounts[name] = (userCounts[name] || 0) + 1;
                });

                const sortedUsers = Object.entries(userCounts).sort(([,a], [,b]) => b - a);

                const leaderboardDiv = document.getElementById('leaderboard-list');
                if(leaderboardDiv) {
                    leaderboardDiv.innerHTML = ""; 

                    sortedUsers.forEach(([name, count], index) => {
                        const rank = index + 1;
                        let icon = "#" + rank;
                        if(rank === 1) icon = "ü•á";
                        if(rank === 2) icon = "ü•à";
                        if(rank === 3) icon = "ü•â";

                        const row = document.createElement('div');
                        row.className = 'rank-row';
                        row.innerHTML = `
                            <div class="rank-num">${icon}</div>
                            <div class="rank-name">${name} ${name === currentUser.displayName ? "(Du)" : ""}</div>
                            <div class="rank-count">${count}</div>
                        `;
                        leaderboardDiv.appendChild(row);
                    });
                }

                // Badges
                const myName = currentUser.displayName;
                const myCount = userCounts[myName] || 0;
                animateValue("my-count", 0, myCount, 1500);

                if (myCount >= 1) document.getElementById('badge-1').classList.add('unlocked');
                if (myCount >= 10) document.getElementById('badge-10').classList.add('unlocked');
                if (myCount >= 50) document.getElementById('badge-50').classList.add('unlocked');
                if (myCount >= 100) document.getElementById('badge-100').classList.add('unlocked');
            });
        }

        // ============================================
        // 3. CHART HELPER FUNKTIONEN üìä
        // ============================================
        let typeChartInstance = null;
        function renderPieChart(counts) {
            const canvas = document.getElementById('typeChart');
            if(!canvas) return;
            const ctx = canvas.getContext('2d');
            
            if(typeChartInstance) typeChartInstance.destroy();

            typeChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(counts),
                    datasets: [{
                        data: Object.values(counts),
                        backgroundColor: ['#d4b483', '#8d6e63', '#e0d0c0', '#4a2c20', '#10b981'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { position: 'bottom', labels: { color: '#aaa' } } }
                }
            });
        }

        let timeChartInstance = null;
        function renderTimeChart(hours) {
            const canvas = document.getElementById('timeChart');
            if(!canvas) return;
            const ctx = canvas.getContext('2d');
            
            if(timeChartInstance) timeChartInstance.destroy();

            const labels = [];
            for(let i=0; i<24; i++) labels.push(i + " Uhr");

            timeChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Koffein-Level',
                        data: hours,
                        borderColor: '#d4b483',
                        backgroundColor: 'rgba(212, 180, 131, 0.2)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    scales: {
                        y: { beginAtZero: true, ticks: { stepSize: 1, color: '#888' }, grid: { color: 'rgba(255,255,255,0.05)' } },
                        x: { ticks: { color: '#888' }, grid: { display: false } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        function animateValue(id, start, end, duration) {
            const obj = document.getElementById(id);
            if(!obj) return;
            if(start === end) { obj.innerHTML = end; return; }
            let range = end - start;
            let current = start;
            let increment = end > start ? 1 : -1;
            let stepTime = Math.abs(Math.floor(duration / range));
            let timer = setInterval(function() {
                current += increment;
                obj.innerHTML = current;
                if (current == end) clearInterval(timer);
            }, stepTime);
        }

        // ==========================================
        // 4. MIGRATIONS-WERKZEUG (V2) üõ†Ô∏è
        // ==========================================
        const btn = document.createElement('button');
        btn.innerText = "üîÑ Preise aktualisieren & neu berechnen";
        btn.style.cssText = "display:block; margin: 30px auto; padding: 15px; background: #333; color: #fff; border: 1px solid #777; border-radius: 10px; cursor: pointer;";
        btn.onclick = importOldData;
        const container = document.querySelector('.container');
        if(container) container.appendChild(btn);

        function importOldData() {
            if(!currentUser) return alert("Bitte erst einloggen!");
            if(!confirm(`M√∂chtest du die Ersparnisse f√ºr alle vergangenen Bestellungen basierend auf der neuen Preisliste neu berechnen?`)) return;

            const starbucksPreise = {
                "Kaffee": 3.50, "Caf√© Crema": 3.90, "Latte Macchiato": 4.50, "Milchkaffee": 4.20,
                "Cappuccino": 4.20, "Espresso": 2.90, "Espresso Lungo": 3.20, "Americano": 3.50,
                "Flat White": 4.50, "Iced Matcha Latte": 5.50, "Iced Protein Matcha": 5.90,
                "Iced Coffee": 3.90, "Iced Latte": 4.50, "To-Go-Becher": 0.00, "Hei√ües Wasser": 0.00
            };
            const standardPreis = 4.00;

            const globalOrdersRef = ref(db, 'orders');
            const myHistoryRef = ref(db, `users/${currentUser.uid}/history`);

            get(globalOrdersRef).then((snapshot) => {
                const data = snapshot.val();
                if(!data) return alert("Keine Bestellungen gefunden.");

                const allOrders = Object.values(data);
                const myOrders = allOrders.filter(o => o.user === currentUser.displayName);

                if(myOrders.length === 0) return alert("Du hast noch nie etwas bestellt!");

                const newHistory = {};
                let count = 0;
                
                myOrders.forEach(order => {
                    const key = "migrated_" + order.timestamp;
                    const prodName = order.coffee || "Kaffee";
                    const savedAmount = starbucksPreise[prodName] !== undefined ? starbucksPreise[prodName] : standardPreis;

                    newHistory[key] = {
                        product: prodName,
                        timestamp: order.timestamp,
                        saved: savedAmount
                    };
                    count++;
                });

                set(myHistoryRef, newHistory).then(() => {
                    alert(`‚úÖ Erledigt! Die Preise f√ºr ${count} Bestellungen wurden korrigiert.`);
                    window.location.reload();
                });

            }).catch((err) => {
                alert("Fehler: " + err.message);
            });
        }
    </script>
</body>
</html>
