<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>G√§stebuch - Timo's Barista Bar</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="assets/img/icon.png">
    <meta name="theme-color" content="#2c1e16">
    
    <meta name="view-transition" content="same-origin">
    
    <link rel="stylesheet" href="assets/css/style.css">
</head>
<body>

    <a href="index.html" style="position: fixed; top: 20px; right: 15px; z-index: 1100; text-decoration: none; font-size: 1.5rem;">üè†</a>

    <h1>Timo's</h1>
    <div class="subtitle">Barista Bar</div>

    <nav class="navbar">
        <a href="index.html" class="nav-link">Bestellen</a>
        <a href="maschine.html" class="nav-link">Maschine</a>
        <a href="bohnen.html" class="nav-link">Bohnen</a>
        <a href="glaeser.html" class="nav-link">Gl√§ser</a>
        <a href="feedback.html" class="nav-link active">Feedback</a>
    </nav>

    <div class="content-container"> <div class="input-card">
            <div style="margin-bottom: 10px; color: #d4b483; font-weight: bold;">üìù Dein Eintrag</div>
            <textarea id="msg-input" class="feedback-input" rows="3" placeholder="Wie hat's geschmeckt?"></textarea>
            <button class="send-btn" onclick="postMessage()">Senden</button>
            <div style="clear:both"></div>
        </div>

        <div id="message-stream" class="message-list">
            <div style="text-align:center; color:#888;">Lade Nachrichten...</div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, push } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // FIREBASE CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyCy8RnpwpL0RdjfaU690j7mKAzr1fiWFXk",
            authDomain: "timos-barista-bar.firebaseapp.com",
            databaseURL: "https://timos-barista-bar-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "timos-barista-bar",
            storageBucket: "timos-barista-bar.firebasestorage.app",
            messagingSenderId: "94308664114",
            appId: "1:94308664114:web:13ace1464e7b3db9054d2b"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);

        let currentUser = null;

        // AUTH CHECK
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
            } else {
                window.location.href = "login.html";
            }
        });

        // --- NACHRICHT SENDEN ---
        window.postMessage = function() {
            const input = document.getElementById('msg-input');
            const text = input.value.trim();

            if (!text) return;
            if (!currentUser) { alert("Bitte erst einloggen!"); return; }

            push(ref(db, 'guestbook'), {
                user: currentUser.displayName || "Unbekannt",
                text: text,
                timestamp: Date.now()
            });

            input.value = ""; // Feld leeren
        }

        // --- NACHRICHTEN LADEN (LIVE) ---
        const guestbookRef = ref(db, 'guestbook');
        const listDiv = document.getElementById('message-stream');

        onValue(guestbookRef, (snapshot) => {
            const data = snapshot.val();
            listDiv.innerHTML = ""; // Liste leeren

            if (!data) {
                listDiv.innerHTML = "<div style='text-align:center; color:#888;'>Noch keine Eintr√§ge. Sei der Erste!</div>";
                return;
            }

            // In Array umwandeln und sortieren (Neueste oben)
            const messages = Object.values(data).sort((a, b) => b.timestamp - a.timestamp);

            messages.forEach(msg => {
                const date = new Date(msg.timestamp);
                const dateStr = date.toLocaleDateString() + " " + date.toLocaleTimeString().slice(0,5);

                const card = document.createElement('div');
                card.className = 'msg-card';
                card.innerHTML = `
                    <div class="msg-header">
                        <span>${msg.user}</span>
                        <span class="msg-time">${dateStr}</span>
                    </div>
                    <div class="msg-body">${msg.text}</div>
                `;
                listDiv.appendChild(card);
            });
        });
    </script>
</body>
</html>
