<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GÃ¤stebuch - Timo's Barista Bar</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="assets/img/icon.png">
    <meta name="theme-color" content="#2c1e16">
    <meta name="view-transition" content="same-origin">
    <link rel="stylesheet" href="assets/css/style.css">
</head>
<body>

    <a href="index.html" style="position: fixed; top: 20px; right: 15px; z-index: 1100; text-decoration: none; font-size: 1.5rem;">ğŸ </a>

    <h1>Timo's</h1>
    <div class="subtitle">Barista Bar</div>

    <nav class="navbar">
        <a href="index.html" class="nav-link">Bestellen</a>
        <a href="maschine.html" class="nav-link">Maschine</a>
        <a href="bohnen.html" class="nav-link">Bohnen</a>
        <a href="glaeser.html" class="nav-link">GlÃ¤ser</a>
        <a href="feedback.html" class="nav-link active">Feedback</a>
    </nav>

    <div class="content-container">

        <div class="rating-summary scroll-reveal">
            <div id="avg-score" class="avg-score">--</div>
            <div id="avg-stars" class="avg-stars">â˜†â˜†â˜†â˜†â˜†</div>
            <div id="avg-count" class="avg-count">Lade Bewertungen...</div>
        </div>
        
        <div class="input-card scroll-reveal">
            <div style="margin-bottom: 10px; color: #d4b483; font-weight: bold;">ğŸ“ Dein Feedback</div>
            
            <div class="star-input-wrapper">
                <span class="star-btn" onclick="setRating(1)">â˜…</span>
                <span class="star-btn" onclick="setRating(2)">â˜…</span>
                <span class="star-btn" onclick="setRating(3)">â˜…</span>
                <span class="star-btn" onclick="setRating(4)">â˜…</span>
                <span class="star-btn" onclick="setRating(5)">â˜…</span>
            </div>

            <textarea id="msg-input" class="feedback-input" rows="3" placeholder="Wie hat der Kaffee geschmeckt?"></textarea>
            <button class="send-btn" onclick="postMessage()">Senden</button>
            <div style="clear:both"></div>
        </div>

        <div id="message-stream" class="message-list">
            <div style="text-align:center; color:#888;">Lade Nachrichten...</div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, push } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCy8RnpwpL0RdjfaU690j7mKAzr1fiWFXk",
            authDomain: "timos-barista-bar.firebaseapp.com",
            databaseURL: "https://timos-barista-bar-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "timos-barista-bar",
            storageBucket: "timos-barista-bar.firebasestorage.app",
            messagingSenderId: "94308664114",
            appId: "1:94308664114:web:13ace1464e7b3db9054d2b"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);

        let currentUser = null;
        let currentRating = 0; // Speichert die gewÃ¤hlten Sterne (1-5)

        onAuthStateChanged(auth, (user) => {
            if (user) currentUser = user;
            else window.location.href = "login.html";
        });

        // --- STERNE LOGIK (Klick) ---
        window.setRating = function(n) {
            currentRating = n;
            const stars = document.querySelectorAll('.star-btn');
            stars.forEach((star, index) => {
                if (index < n) star.classList.add('active');
                else star.classList.remove('active');
            });
        }

        // --- SENDEN ---
        window.postMessage = function() {
            const input = document.getElementById('msg-input');
            const text = input.value.trim();

            if (!text && currentRating === 0) { alert("Bitte Text oder Sterne eingeben!"); return; }
            if (!currentUser) { alert("Bitte erst einloggen!"); return; }

            push(ref(db, 'guestbook'), {
                user: currentUser.displayName || "Unbekannt",
                text: text,
                rating: currentRating, // Speichert die Sterne
                timestamp: Date.now()
            });

            // Reset
            input.value = "";
            setRating(0); // Sterne zurÃ¼cksetzen
        }

        // --- LADEN & DURCHSCHNITT BERECHNEN ---
        const guestbookRef = ref(db, 'guestbook');
        const listDiv = document.getElementById('message-stream');

        // Elemente fÃ¼r den Durchschnitt
        const scoreEl = document.getElementById('avg-score');
        const starsEl = document.getElementById('avg-stars');
        const countEl = document.getElementById('avg-count');

        onValue(guestbookRef, (snapshot) => {
            const data = snapshot.val();
            listDiv.innerHTML = "";

            if (!data) {
                listDiv.innerHTML = "<div style='text-align:center; color:#888;'>Noch keine EintrÃ¤ge.</div>";
                scoreEl.innerText = "--";
                return;
            }

            const messages = Object.values(data).sort((a, b) => b.timestamp - a.timestamp);

            // 1. Durchschnitt berechnen
            let totalStars = 0;
            let ratingCount = 0;

            messages.forEach(msg => {
                if (msg.rating > 0) {
                    totalStars += msg.rating;
                    ratingCount++;
                }
            });

            if (ratingCount > 0) {
                const average = (totalStars / ratingCount).toFixed(1); // z.B. 4.8
                scoreEl.innerText = average;
                countEl.innerText = `Basierend auf ${ratingCount} Bewertungen`;
                
                // Sterne String bauen (z.B. â˜…â˜…â˜…â˜…â˜†)
                let starStr = "";
                const rounded = Math.round(average);
                for(let i=0; i<5; i++) starStr += i < rounded ? "â˜…" : "â˜†";
                starsEl.innerText = starStr;
            } else {
                scoreEl.innerText = "-.-";
                countEl.innerText = "Noch keine Bewertungen";
            }

            // 2. Liste anzeigen
            messages.forEach(msg => {
                const date = new Date(msg.timestamp);
                const dateStr = date.toLocaleDateString();

                // Sterne fÃ¼r diesen Eintrag generieren
                let userStars = "";
                if(msg.rating > 0) {
                    for(let i=0; i<msg.rating; i++) userStars += "â˜…";
                }

                const card = document.createElement('div');
                card.className = 'msg-card scroll-reveal'; // Scroll Animation
                card.innerHTML = `
                    <div class="msg-header">
                        <span>${msg.user}</span>
                        <span class="msg-time">${dateStr}</span>
                    </div>
                    ${userStars ? `<div class="msg-rating">${userStars}</div>` : ''}
                    <div class="msg-body" style="margin-top:5px;">${msg.text}</div>
                `;
                listDiv.appendChild(card);
            });
            
            // Animationen initialisieren (falls du die main.js Funktionen hier hÃ¤ttest, 
            // aber wir lassen es simpel per CSS Animation)
        });
    </script>
</body>
</html>
