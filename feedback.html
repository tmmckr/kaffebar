<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GÃ¤stebuch - Timo's Barista Bar</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="assets/img/icon.png">
    <meta name="theme-color" content="#2c1e16">
    <meta name="view-transition" content="same-origin">
    <link rel="stylesheet" href="assets/css/style.css">
    <script src="assets/js/menu.js"></script>
</head>
<body>
    <div class="aurora-blob blob-1"></div>
    <div class="aurora-blob blob-2"></div>
    <div class="aurora-blob blob-3"></div>


    <h1>Timo's</h1>
    <div class="subtitle">Barista Bar</div>

    <div class="hamburger-btn" onclick="toggleMenu(event)">â˜°</div>

<div id="main-dropdown" class="dropdown-menu">
    <a href="stats.html" class="menu-item">
        <span>ğŸ†</span> Stats & Wrapped
    </a>
    <a href="preise.html" class="menu-item">
        <span>ğŸ’°</span> Preisliste
    </a>
    <a href="feedback.html" class="menu-item">
        <span>ğŸ’¬</span> GÃ¤stebuch
    </a>

    <div class="menu-divider"></div>

    <a href="javascript:checkAdminAccess()" class="menu-item">
        <span>ğŸ‘¨â€ğŸ³</span> Admin
    </a>
    <a href="javascript:logout()" class="menu-item" style="color: #fca5a5;">
        <span>ğŸšª</span> Logout
    </a>
</div>

    <nav class="navbar">
        <a href="app.html" class="nav-link">Bestellen</a>
        <a href="maschine.html" class="nav-link">Maschine</a>
        <a href="bohnen.html" class="nav-link">Bohnen</a>
        <a href="glaeser.html" class="nav-link">GlÃ¤ser</a>
        <a href="feedback.html" class="nav-link active">Feedback</a>
    </nav>

    <div class="content-container">

        <div class="rating-summary scroll-reveal">
            <div id="avg-score" class="avg-score">--</div>
            <div id="avg-stars" class="avg-stars">â˜†â˜†â˜†â˜†â˜†</div>
            <div id="avg-count" class="avg-count">Lade Bewertungen...</div>
        </div>
        
        <div class="input-card scroll-reveal">
            <div style="margin-bottom: 10px; color: #d4b483; font-weight: bold;">ğŸ“ Dein Feedback</div>
            
            <div class="star-input-wrapper">
                <span class="star-btn" onclick="setRating(1)">â˜…</span>
                <span class="star-btn" onclick="setRating(2)">â˜…</span>
                <span class="star-btn" onclick="setRating(3)">â˜…</span>
                <span class="star-btn" onclick="setRating(4)">â˜…</span>
                <span class="star-btn" onclick="setRating(5)">â˜…</span>
            </div>

            <textarea id="msg-input" class="feedback-input" rows="3" placeholder="Wie hat der Kaffee geschmeckt?"></textarea>
            <button class="send-btn" onclick="postMessage()">Senden</button>
            <div style="clear:both"></div>
        </div>

        <div id="message-stream" class="message-list">
            <div style="text-align:center; color:#888;">Lade Nachrichten...</div>
        </div>

    </div>

    <div id="toast-container"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, push } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCy8RnpwpL0RdjfaU690j7mKAzr1fiWFXk",
            authDomain: "timos-barista-bar.firebaseapp.com",
            databaseURL: "https://timos-barista-bar-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "timos-barista-bar",
            storageBucket: "timos-barista-bar.firebasestorage.app",
            messagingSenderId: "94308664114",
            appId: "1:94308664114:web:13ace1464e7b3db9054d2b"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);

        // --- TOAST FUNKTION (Ersetzt Alert) ---
        window.showToast = function(message, type = 'info') {
            const container = document.getElementById('toast-container');
            if(!container) return;

            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            let icon = 'ğŸ’¬';
            if(type === 'success') icon = 'âœ…';
            if(type === 'error') icon = 'âŒ';

            toast.innerHTML = `<span>${icon}</span> <span>${message}</span>`;
            container.appendChild(toast);

            // Animation starten
            requestAnimationFrame(() => { toast.classList.add('show'); });

            // Nach 3s entfernen
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 400);
            }, 3000);
        }

        // Observer fÃ¼r Scroll Animation
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('visible');
                    observer.unobserve(entry.target);
                }
            });
        }, { threshold: 0.1 });
        document.querySelectorAll('.scroll-reveal').forEach(el => observer.observe(el));


        let currentUser = null;
        let currentRating = 0; 

        onAuthStateChanged(auth, (user) => {
            if (user) currentUser = user;
            else window.location.href = "login.html";
        });

        window.setRating = function(n) {
            currentRating = n;
            const stars = document.querySelectorAll('.star-btn');
            stars.forEach((star, index) => {
                if (index < n) star.classList.add('active');
                else star.classList.remove('active');
            });
            // Kleines Feedback beim Tippen
            if(navigator.vibrate) navigator.vibrate(15);
        }

        window.postMessage = function() {
            const input = document.getElementById('msg-input');
            const text = input.value.trim();

            // *** HIER SIND JETZT DIE TOASTS STATT ALERTS ***
            if (!text && currentRating === 0) { 
                showToast("Bitte Text oder Sterne eingeben!", "error"); 
                if(navigator.vibrate) navigator.vibrate(100); // Fehler-Vibration
                return; 
            }
            if (!currentUser) { 
                showToast("Bitte erst einloggen!", "error"); 
                return; 
            }

            push(ref(db, 'guestbook'), {
                user: currentUser.displayName || "Unbekannt",
                text: text,
                rating: currentRating,
                timestamp: Date.now()
            });

            // Erfolg!
            showToast("Danke fÃ¼r dein Feedback!", "success");
            if(navigator.vibrate) navigator.vibrate([50, 50]); 

            input.value = "";
            setRating(0);

            if (!text && currentRating === 0) { 
                showToast("Bitte Text oder Sterne eingeben!", "error"); 
                
                // NEU: Langes Fehler-Brummen
                if(navigator.vibrate) navigator.vibrate(200); 
                
                return; 
            }
        }

        const guestbookRef = ref(db, 'guestbook');
        const listDiv = document.getElementById('message-stream');
        const scoreEl = document.getElementById('avg-score');
        const starsEl = document.getElementById('avg-stars');
        const countEl = document.getElementById('avg-count');

        onValue(guestbookRef, (snapshot) => {
            const data = snapshot.val();
            listDiv.innerHTML = "";

            if (!data) {
                listDiv.innerHTML = "<div style='text-align:center; color:#888;'>Noch keine EintrÃ¤ge.</div>";
                scoreEl.innerText = "--";
                return;
            }

            const messages = Object.values(data).sort((a, b) => b.timestamp - a.timestamp);

            let totalStars = 0;
            let ratingCount = 0;

            messages.forEach(msg => {
                if (msg.rating > 0) {
                    totalStars += msg.rating;
                    ratingCount++;
                }
            });

            if (ratingCount > 0) {
                const average = (totalStars / ratingCount).toFixed(1); 
                scoreEl.innerText = average;
                countEl.innerText = `Basierend auf ${ratingCount} Bewertungen`;
                
                let starStr = "";
                const rounded = Math.round(average);
                for(let i=0; i<5; i++) starStr += i < rounded ? "â˜…" : "â˜†";
                starsEl.innerText = starStr;
            } else {
                scoreEl.innerText = "-.-";
                countEl.innerText = "Noch keine Bewertungen";
            }

            messages.forEach(msg => {
                const date = new Date(msg.timestamp);
                const dateStr = date.toLocaleDateString();

                let userStars = "";
                if(msg.rating > 0) {
                    for(let i=0; i<msg.rating; i++) userStars += "â˜…";
                }

                const card = document.createElement('div');
                card.className = 'msg-card scroll-reveal';
                card.innerHTML = `
                    <div class="msg-header">
                        <span>${msg.user}</span>
                        <span class="msg-time">${dateStr}</span>
                    </div>
                    ${userStars ? `<div class="msg-rating">${userStars}</div>` : ''}
                    <div class="msg-body" style="margin-top:5px;">${msg.text}</div>
                `;
                listDiv.appendChild(card);
                observer.observe(card);
            });
        });
    </script>
</body>
</html>
