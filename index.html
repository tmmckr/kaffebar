<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Timo's Barista Bar</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#2c1e16">
    <style>

        /* --- SCHNEE EFFEKT --- */
        #snow-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* Der Zauber-Befehl: Klicks gehen durch! */
            z-index: 9999; /* Ganz oben dr√ºber */
            overflow: hidden;
        }

        .snowflake {
            position: absolute;
            background-color: white;
            border-radius: 50%;
            opacity: 0.8;
            pointer-events: none;
            animation: fall linear infinite;
        }

        @keyframes fall {
            0% {
                transform: translateY(-10vh) translateX(0);
                opacity: 1;
            }
            100% {
                transform: translateY(105vh) translateX(20px); /* F√§llt nach unten & leicht zur Seite */
                opacity: 0.3;
            }
        }
        /* --- Grundlegendes Design --- */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; color: #e0d0c0; margin: 0; padding: 25px 15px; min-height: 100vh; position: relative; }
        body::before { content: ""; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background: linear-gradient(rgba(44, 30, 22, 0.85), rgba(15, 10, 6, 0.95)), url('coffee-5447420_1920.jpg'); background-size: cover; background-position: center; }
        h1 { font-family: "Times New Roman", serif; color: #d4b483; font-weight: normal; font-size: 2.8rem; margin-bottom: 5px; text-align: center; letter-spacing: 1px; padding-top: 25px; }
        .subtitle { text-align: center; color: #d4b483; font-family: "Times New Roman", serif; font-size: 1.2rem; margin-bottom: 20px; position: relative; }
        .subtitle::after { content: ''; display: block; width: 50px; height: 2px; background: #d4b483; margin: 15px auto 0; opacity: 0.6; }

        /* --- Navigation (Angepasst f√ºr 5 Links) --- */
        .navbar {
            position: sticky; top: 20px; z-index: 1000;
            width: 95%; max-width: 600px; margin: 0 auto 30px auto;
            background: rgba(44, 30, 22, 0.85); backdrop-filter: blur(12px);
            border: 1px solid rgba(212, 180, 131, 0.3); border-radius: 50px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.4);
            display: flex; justify-content: space-between; align-items: center; padding: 4px;
        }
        .nav-link {
            color: #e0d0c0; text-decoration: none; 
            font-size: 0.65rem; /* Etwas kleiner f√ºr 5 Elemente */
            padding: 10px 4px; /* Weniger Abstand */
            letter-spacing: 0.5px;
            text-transform: uppercase; font-weight: bold; border-radius: 40px; transition: all 0.3s ease;
            flex: 1; text-align: center; white-space: nowrap;
        }
        .nav-link:hover { color: #fff; background: rgba(255,255,255,0.05); }
        .nav-link.active { background-color: #d4b483; color: #2c1e16; box-shadow: 0 2px 10px rgba(212, 180, 131, 0.3); }

        /* --- NEU: Logout Button (Oben Rechts) --- */
        .logout-btn {
            position: fixed; top: 20px; right: 15px; z-index: 1100;
            background: rgba(44, 30, 22, 0.85); backdrop-filter: blur(12px);
            border: 1px solid rgba(212, 180, 131, 0.3); border-radius: 30px;
            color: #d4b483; font-size: 0.7rem; font-weight: bold; text-transform: uppercase;
            padding: 8px 15px; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            transition: all 0.2s ease;
        }
        .logout-btn:active { transform: scale(0.95); background: #d4b483; color: #2c1e16; }

        /* --- Status Ampel --- */
        .status-container { text-align: center; margin-bottom: 25px; min-height: 40px; }
        .status-badge { display: inline-flex; align-items: center; gap: 8px; padding: 6px 16px; border-radius: 20px; font-weight: bold; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); transition: all 0.3s ease; }
        .status-loading { background: rgba(255, 255, 255, 0.1); border: 1px solid #aaa; color: #aaa; }
        .status-open { background: rgba(16, 185, 129, 0.2); border: 1px solid #10b981; color: #10b981; }
        .status-closed { background: rgba(239, 68, 68, 0.2); border: 1px solid #ef4444; color: #ef4444; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; }
        .dot-green { background-color: #10b981; box-shadow: 0 0 10px #10b981; }
        .dot-red { background-color: #ef4444; box-shadow: 0 0 10px #ef4444; }
        .shop-closed-mode { opacity: 0.4; pointer-events: none; filter: grayscale(100%); transition: all 0.5s; }

        /* --- UI Elemente --- */
        .news-banner { background: rgba(212, 180, 131, 0.1); border: 1px solid rgba(212, 180, 131, 0.5); color: #e0d0c0; padding: 12px 15px; margin: 0 auto 30px auto; max-width: 600px; border-radius: 12px; text-align: center; font-size: 0.95rem; display: flex; align-items: center; justify-content: center; gap: 12px; backdrop-filter: blur(5px); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .news-badge { background: #d4b483; color: #2c1e16; font-weight: bold; font-size: 0.75rem; padding: 4px 8px; border-radius: 6px; letter-spacing: 1px; white-space: nowrap; }
        
        .bean-card { background: linear-gradient(145deg, rgba(40, 30, 25, 0.9), rgba(20, 15, 10, 0.9)); border: 1px solid rgba(212, 180, 131, 0.4); padding: 20px; border-radius: 12px; margin: 0 auto 40px auto; max-width: 600px; text-align: center; box-shadow: 0 10px 20px rgba(0,0,0,0.3); position: relative; overflow: hidden; }
        .bean-card::before { content: ''; position: absolute; top: -50px; left: -50px; width: 100px; height: 100px; background: radial-gradient(circle, rgba(255,255,255,0.1), transparent 70%); }
        .bean-label { color: #d4b483; font-size: 0.75rem; letter-spacing: 2px; text-transform: uppercase; margin-bottom: 8px; opacity: 0.8; }
        .bean-name { font-family: "Times New Roman", serif; font-size: 1.6rem; color: #fff; margin-bottom: 5px; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
        .bean-desc { color: #a09085; font-size: 0.9rem; margin-bottom: 15px; font-style: italic; }
        .intensity-wrapper { display: flex; align-items: center; justify-content: center; gap: 15px; font-size: 0.8rem; color: #d4b483; font-weight: bold; letter-spacing: 1px;}
        .progress-bar-bg { width: 120px; height: 6px; background: rgba(212, 180, 131, 0.2); border-radius: 3px; overflow: hidden; }
        .progress-fill { height: 100%; background: #d4b483; width: 70%; box-shadow: 0 0 10px rgba(212, 180, 131, 0.5); }

        .menu-list { display: flex; flex-direction: column; gap: 20px; max-width: 600px; margin: 0 auto; padding-bottom: 50px; }
        .coffee-card { background: rgba(40, 30, 25, 0.7); border: 1px solid rgba(212, 180, 131, 0.2); border-radius: 12px; padding: 20px 25px; cursor: pointer; transition: all 0.2s ease; text-align: left; position: relative; backdrop-filter: blur(5px); }
        .coffee-card:active { transform: scale(0.96); background: rgba(60, 45, 35, 0.9); border-color: rgba(212, 180, 131, 0.8); }
        .name { font-size: 1.3rem; font-weight: 500; color: #fff; margin-bottom: 12px; }
        .desc { font-size: 0.95rem; color: #a09085; line-height: 1.5; margin-bottom: 20px; }
        .strength-container { display: flex; align-items: center; font-size: 0.75rem; color: #d4b483; letter-spacing: 1.5px; text-transform: uppercase; }
        .dots { margin-left: 10px; letter-spacing: 3px; font-size: 1rem; }
        .dot-filled { color: #d4b483; } .dot-empty { color: rgba(212, 180, 131, 0.2); }

        /* --- Modals --- */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); z-index: 1000; justify-content: center; align-items: center; backdrop-filter: blur(8px); animation: fadeIn 0.3s; }
        .modal-box { background: #2c1e16; border: 2px solid #d4b483; padding: 25px; border-radius: 15px; text-align: center; width: 90%; max-width: 350px; box-shadow: 0 0 30px rgba(212, 180, 131, 0.2); animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); max-height: 90vh; overflow-y: auto; }
        .modal-title { color: #d4b483; font-family: "Times New Roman", serif; font-size: 1.6rem; margin: 0 0 15px 0; }
        .form-group { margin-bottom: 15px; text-align: left; }
        .form-label { display: block; color: #a09085; font-size: 0.85rem; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 1px; }
        .modal-input, .modal-select { width: 100%; padding: 12px; background: rgba(0, 0, 0, 0.3); border: 1px solid #d4b483; border-radius: 8px; color: white; font-size: 1rem; outline: none; box-sizing: border-box; }
        .modal-select { appearance: none; background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23d4b483'%3e%3cpath d='M7 10l5 5 5-5z'/%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: right 10px center; background-size: 20px; }
        .checkbox-group { display: flex; flex-direction: column; gap: 10px; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px; border: 1px solid rgba(212, 180, 131, 0.1); }
        .checkbox-item { display: flex; align-items: center; gap: 12px; cursor: pointer; color: white; font-size: 1rem; }
        .checkbox-item input { accent-color: #d4b483; width: 20px; height: 20px; cursor: pointer; }
        input[type=range] { width: 100%; -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 20px; width: 20px; border-radius: 50%; background: #d4b483; margin-top: -8px; box-shadow: 0 0 5px rgba(0,0,0,0.5); }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: rgba(212, 180, 131, 0.3); border-radius: 2px; }
        .range-value { float: right; color: #d4b483; font-weight: bold; }
        .radio-group { display: flex; gap: 10px; }
        .radio-label { flex: 1; text-align: center; padding: 10px; border: 1px solid rgba(212, 180, 131, 0.5); border-radius: 8px; cursor: pointer; color: #a09085; transition: 0.2s; }
        input[type="radio"] { display: none; }
        input[type="radio"]:checked + .radio-label { background: #d4b483; color: #2c1e16; font-weight: bold; border-color: #d4b483; }
        .modal-btn { background: #d4b483; color: #2c1e16; border: none; padding: 12px 30px; font-size: 1rem; font-weight: bold; border-radius: 25px; cursor: pointer; text-transform: uppercase; letter-spacing: 1px; width: 100%; margin-top: 10px; }
        
        /* Geschlossen-Info */
        .closed-info-box { display: none; background: rgba(239, 68, 68, 0.15); border: 1px solid #ef4444; color: #fca5a5; padding: 15px; margin: 0 auto 30px auto; max-width: 600px; border-radius: 12px; text-align: center; backdrop-filter: blur(5px); animation: fadeIn 0.5s; }
        .bot-link { color: #d4b483; font-weight: bold; text-decoration: underline; cursor: pointer; }

        #status { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: #ef4444; color: white; padding: 12px 25px; border-radius: 30px; display: none; z-index: 100; font-weight: bold; text-align: center; width: 80%; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* --- CHATBOT --- */
        .chat-toggle { position: fixed; bottom: 80px; right: 20px; background: #d4b483; color: #2c1e16; width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 30px; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.5); z-index: 2000; transition: transform 0.2s; }
        .chat-toggle:active { transform: scale(0.9); }
        .chat-window { position: fixed; bottom: 150px; right: 20px; width: 300px; height: 450px; background: #2c1e16; border: 2px solid #d4b483; border-radius: 15px; display: none; flex-direction: column; box-shadow: 0 10px 30px rgba(0,0,0,0.8); z-index: 2000; overflow: hidden; animation: popIn 0.3s; }
        .chat-header { background: #d4b483; color: #2c1e16; padding: 10px; font-weight: bold; text-align: center; display: flex; justify-content: space-between; align-items: center; }
        .close-chat { cursor: pointer; font-size: 1.2rem; }
        .chat-messages { flex: 1; padding: 10px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .message { max-width: 80%; padding: 8px 12px; border-radius: 10px; font-size: 0.9rem; line-height: 1.4; }
        .bot-msg { background: rgba(255,255,255,0.1); color: #ddd; align-self: flex-start; border-bottom-left-radius: 0; }
        .user-msg { background: #d4b483; color: #2c1e16; align-self: flex-end; border-bottom-right-radius: 0; }
        .chat-input-area { padding: 10px; border-top: 1px solid rgba(212, 180, 131, 0.3); display: flex; gap: 5px; }
        .chat-input { flex: 1; padding: 10px; border-radius: 5px; border: none; outline: none; }
        .chat-send { background: #d4b483; border: none; padding: 0 15px; border-radius: 5px; cursor: pointer; font-size: 1.2rem; }

        /* --- DAMPF EFFEKT --- */
        .steam-particle {
            position: fixed; /* Damit es √ºber dem Modal schwebt */
            background: radial-gradient(circle, rgba(255,255,255,0.8) 0%, rgba(255,255,255,0) 70%);
            border-radius: 50%;
            pointer-events: none;
            z-index: 10000; /* Ganz oben drauf */
            animation: steamRise 1.5s ease-out forwards;
            filter: blur(4px); /* Macht es wolking/weich */
        }

        @keyframes steamRise {
            0% { 
                transform: translateY(0) scale(0.5); 
                opacity: 0.6; 
            }
            100% { 
                /* Steigt 150px nach oben und wird gro√ü und unsichtbar */
                transform: translateY(-150px) scale(3); 
                opacity: 0; 
            }
        }
    </style>
</head>
<body>

    <button class="logout-btn" onclick="window.logout()">Logout üö™</button>

    <h1>Timo's</h1>
    <div class="subtitle">Barista Bar</div>

    <nav class="navbar">
        <a href="index.html" class="nav-link active">Bestellen</a>
        <a href="maschine.html" class="nav-link">Maschine</a>
        <a href="bohnen.html" class="nav-link">Bohnen</a>
        <a href="glaeser.html" class="nav-link">Gl√§ser</a>
        <a href="feedback.html" class="nav-link">Feedback</a>
    </nav>

    <div class="status-container">
        <div id="status-badge" class="status-badge status-open">
            <span class="status-dot dot-green"></span>
            <span id="status-text">Pr√ºfe Status...</span>
        </div>
    </div>

    <div id="closed-message-box" class="closed-info-box">
        üî¥ Die Barista Bar ist gerade zu.<br>
        <span style="font-size: 0.9rem; color:#fca5a5;">Du hast trotzdem eine Frage?</span><br>
        <span onclick="window.toggleChat()" class="bot-link">Frag den Barista Bot! ü§ñ</span>
    </div>

    <div class="news-banner">
        <span class="news-badge">NEU</span>
        <span>Iced Matcha Latte ‚Äì auch als Protein-Version! üçµ</span>
    </div>

   <div class="bean-card">
        <div class="bean-label">Aktuelle R√∂stung</div>
        <div class="bean-name">Tchibo Barista Espresso</div>
        <div class="bean-desc">Trommelr√∂stung ‚Ä¢ 100% Arabica</div>
        <div class="intensity-wrapper">
            INTENSIT√ÑT 5/6
            <div class="progress-bar-bg"><div class="progress-fill" style="width: 83%"></div></div>
        </div>
    </div>

    <div class="menu-list" id="menu-container"></div>

    <div id="order-modal" class="modal-overlay">
        <div class="modal-box">
            <h2 class="modal-title" id="modal-coffee-title">Einstellungen</h2>
            <div id="custom-options"></div>
            <button class="modal-btn" onclick="sendOrder()">Bestellen</button>
            <div style="margin-top:15px; font-size:0.8rem; color:#a09085; cursor:pointer;" onclick="closeOrderModal()">Abbrechen</div>
        </div>
    </div>

    <div id="confirmation-modal" class="modal-overlay">
        <div class="modal-box">
            <span style="font-size:3rem; display:block; margin-bottom:15px;">üõéÔ∏è</span>
            <h2 class="modal-title">Bestellung best√§tigt</h2>
            <p class="modal-text" style="color:white; line-height: 1.6;">
                <strong id="confirm-details"></strong><br>
                <span style="font-size:0.9rem; color:#a09085; margin-top:10px; display:block">Serviert in ca. 5 Minuten.</span>
            </p>
            <button class="modal-btn" onclick="closeConfirmModal()">Alles klar!</button>
        </div>
    </div>

    <div id="status"></div>

    <div class="chat-toggle" onclick="window.toggleChat()">ü§ñ</div>
    <div class="chat-window" id="chat-window">
        <div class="chat-header">
            <span>Barista Bot (Gemini)</span>
            <span class="close-chat" onclick="window.toggleChat()">‚úñ</span>
        </div>
        <div class="chat-messages" id="chat-messages">
            <div class="message bot-msg">Hallo! Ich bin dein KI-Barista. Frag mich was zur Karte! ‚òï</div>
        </div>
        <div class="chat-input-area">
            <input type="text" id="chat-input" class="chat-input" placeholder="Frage..." onkeypress="window.handleEnter(event)">
            <button class="chat-send" onclick="window.sendMessage()">‚û§</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, push } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCy8RnpwpL0RdjfaU690j7mKAzr1fiWFXk",
            authDomain: "timos-barista-bar.firebaseapp.com",
            databaseURL: "https://timos-barista-bar-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "timos-barista-bar",
            storageBucket: "timos-barista-bar.firebasestorage.app",
            messagingSenderId: "94308664114",
            appId: "1:94308664114:web:13ace1464e7b3db9054d2b"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);

        const TOPIC_NAME = 'mamas-kaffee-123-geheim'; 
        
        // --- KEY AUS DB LADEN ---
        let GEMINI_API_KEY = null;
        onValue(ref(db, 'geminiKey'), (snapshot) => { GEMINI_API_KEY = snapshot.val(); });

        // --- AUTHENTICATION & T√úRSTEHER ---
        let currentUser = null;
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                console.log("Eingeloggt:", user.displayName);
            } else {
                window.location.href = "login.html";
            }
        });

        window.logout = function() {
            signOut(auth).then(() => window.location.href = "login.html");
        }

        // Elemente
        const statusBadge = document.getElementById('status-badge');
        const statusText = document.getElementById('status-text');
        const statusDot = document.querySelector('.status-dot');
        const container = document.getElementById('menu-container');
        const orderModal = document.getElementById('order-modal');
        const customOptionsDiv = document.getElementById('custom-options');
        const confirmModal = document.getElementById('confirmation-modal');
        const closedMessageBox = document.getElementById('closed-message-box');

        let currentCoffee = null;
        let isShopOpen = true; 

        // FIREBASE STATUS CHECK
        const statusRef = ref(db, 'status');
        onValue(statusRef, (snapshot) => {
            const data = snapshot.val(); 
            const statusStr = data ? String(data).toLowerCase() : "an";
            if (statusStr.includes('aus') || statusStr.includes('zu') || statusStr.includes('closed')) {
                setShopClosed();
            } else {
                setShopOpen();
            }
        });

        function setShopOpen() {
            isShopOpen = true;
            statusBadge.className = 'status-badge status-open';
            statusText.innerText = 'Barista ist bereit';
            statusDot.className = 'status-dot dot-green';
            container.classList.remove('shop-closed-mode');
            if(closedMessageBox) closedMessageBox.style.display = 'none';
        }

        function setShopClosed() {
            isShopOpen = false;
            statusBadge.className = 'status-badge status-closed';
            statusText.innerText = 'Kaffeebar geschlossen';
            statusDot.className = 'status-dot dot-red';
            container.classList.add('shop-closed-mode');
            if(closedMessageBox) closedMessageBox.style.display = 'block';
        }

        // MASCHINEN DATEN
        const maschinenDaten = {
            "Kaffee": { stufen: true, ml_kaffee: [90, 120, 150, 180, 210, 220], cycles: true },
            "Caf√© Crema": { stufen: true, ml_kaffee: [90, 120, 150, 180, 210, 220], cycles: true },
            "Latte Macchiato": { stufen: true, ml_kaffee: [20, 30, 40, 60, 80], ml_milch: [80, 140, 200, 270, 340], cycles: false },
            "Cappuccino": { stufen: true, ml_kaffee: [20, 30, 40, 60, 80], ml_milch: [90, 120, 150, 180, 210], cycles: false },
            "Americano": { stufen: true, ml_kaffee: [80, 100, 120, 160, 200], cycles: true },
            "Espresso Lungo": { stufen: true, ml_kaffee: [80, 100, 120, 160, 200], cycles: true },
            "Espresso": { stufen: true, ml_kaffee: [30, 40, 50], cycles: true },
            "Milchkaffee": { stufen: true, ml_kaffee: [50, 70, 90, 120, 150], ml_milch: [50, 70, 90, 120, 150], cycles: false },
            "Matcha": { stufen: false, ml_gesamt: [200, 250, 300, 350, 400, 450, 500], cycles: false },
            "default": { stufen: false, cycles: false }
        };

        const kaffeeSorten = [
            { name: "Kaffee", configKey: "Kaffee", strength: 3, desc: "Der zeitlose Klassiker." },
            { name: "Caf√© Crema", configKey: "Caf√© Crema", strength: 3, desc: "Langer Genuss mit Crema-Krone." },
            { name: "Espresso Lungo", configKey: "Espresso Lungo", strength: 4, desc: "Verl√§ngertes Aromawunder." },
            { name: "Espresso", configKey: "Espresso", strength: 5, desc: "Der kleine Starke." },
            { name: "Latte Macchiato", configKey: "Latte Macchiato", strength: 2, desc: "Viel hei√üe Milch & Espresso." },
            { name: "Milchkaffee", configKey: "Milchkaffee", strength: 2, desc: "Halb Kaffee, halb Milch." },
            { name: "Cappuccino", configKey: "Cappuccino", strength: 3, desc: "Klassiker mit Milchschaumhaube." },
            { name: "Americano", configKey: "Americano", strength: 3, desc: "Espresso mit Wasser verl√§ngert." },
            { name: "Iced Matcha Latte", configKey: "Matcha", strength: 0, desc: "Gr√ºner Tee auf Eis & Milch." },
            { name: "Iced Protein Matcha", configKey: "Matcha", strength: 0, desc: "Matcha Latte mit Protein-Kick." },
            { name: "Ristretto", configKey: "default", strength: 5, desc: "Ultrakurzer Extrakt." },
            { name: "Flat White", configKey: "default", strength: 4, desc: "Doppelter Ristretto mit Mikroschaum." },
            { name: "Iced Coffee", configKey: "default", strength: 3, desc: "Frisch gebr√ºht auf Eis." },
            { name: "Iced Latte", configKey: "default", strength: 2, desc: "Espresso auf kalter Milch & Eis." },
            { name: "Milchschaum", configKey: "default", strength: 0, desc: "Purer Schaum." },
            { name: "Hei√ües Wasser", configKey: "default", strength: 0, desc: "F√ºr Tee." },
            { name: "To-Go-Becher", configKey: "default", strength: 0, desc: "F√ºr unterwegs." }
        ];

        // GLOBALISIERUNG
        window.openOrderModal = function(sorteName) {
            const sorte = kaffeeSorten.find(k => k.name === sorteName);
            if(!sorte || !isShopOpen) return;

            currentCoffee = sorte;
            document.getElementById('modal-coffee-title').innerText = sorte.name;
            customOptionsDiv.innerHTML = "";

            const config = maschinenDaten[sorte.configKey] || maschinenDaten['default'];

            if (config.stufen) {
                customOptionsDiv.innerHTML += `
                    <div class="form-group">
                        <label class="form-label">Intensit√§t: <span id="strength-val" class="range-value">3</span></label>
                        <input type="range" id="input-strength" min="1" max="6" value="3" oninput="document.getElementById('strength-val').innerText=this.value">
                    </div>`;
            }
            if (config.ml_kaffee) customOptionsDiv.innerHTML += createSelect('input-coffee-vol', 'Kaffeemenge', config.ml_kaffee, ' ml');
            if (config.ml_milch) customOptionsDiv.innerHTML += createSelect('input-milk-vol', 'Milchmenge', config.ml_milch, ' ml');
            if (config.ml_gesamt) customOptionsDiv.innerHTML += createSelect('input-total-vol', 'Gr√∂√üe', config.ml_gesamt, ' ml');
            
            if (config.cycles) {
                customOptionsDiv.innerHTML += `
                    <div class="form-group">
                        <label class="form-label">Mahlvorgang</label>
                        <div class="radio-group">
                            <input type="radio" id="cycle1" name="cycles" value="1x" checked>
                            <label for="cycle1" class="radio-label">1x</label>
                            <input type="radio" id="cycle2" name="cycles" value="2x">
                            <label for="cycle2" class="radio-label">2x</label>
                        </div>
                    </div>`;
            }
            customOptionsDiv.innerHTML += `
                <div class="form-group">
                    <label class="form-label">Sonderwunsch / Ort</label>
                    <input type="text" id="order-comment" class="modal-input" placeholder="z.B. Im Garten, ohne Keks..." autocomplete="off">
                </div>
                <div class="form-group" style="margin-top: 25px; padding-top: 15px; border-top: 1px solid rgba(212, 180, 131, 0.3);">
                    <label class="form-label">Extras</label>
                    <div class="checkbox-group">
                        <label class="checkbox-item"><input type="checkbox" id="extra-vanilla"> mit Vanille Sirup</label>
                        <label class="checkbox-item"><input type="checkbox" id="extra-sweetener"> mit S√º√üstoff</label>
                    </div>
                </div>`;
            
            orderModal.style.display = 'flex';
        }

        window.closeOrderModal = function() { orderModal.style.display = 'none'; }
        window.closeConfirmModal = function() { confirmModal.style.display = 'none'; }

        // --- DAMPF FUNKTION ---
        function createSteamEffect() {
            const btn = document.querySelector('#order-modal .modal-btn');
            if (!btn) return;

            const rect = btn.getBoundingClientRect();
            // Mitte des Buttons finden
            const centerX = rect.left + rect.width / 2;
            const topY = rect.top;

            // 20 Dampfwolken erzeugen
            for (let i = 0; i < 20; i++) {
                const steam = document.createElement('div');
                steam.classList.add('steam-particle');
                
                // Zufallswerte f√ºr nat√ºrliche Optik
                const randomX = (Math.random() - 0.5) * 60; // Streuung nach links/rechts
                const size = Math.random() * 20 + 10; // Gr√∂√üe zwischen 10px und 30px
                const delay = Math.random() * 0.5; // Startet nicht alles gleichzeitig

                steam.style.left = `${centerX + randomX}px`;
                steam.style.top = `${topY}px`;
                steam.style.width = `${size}px`;
                steam.style.height = `${size}px`;
                steam.style.animationDelay = `${delay}s`;

                document.body.appendChild(steam);

                // Nach 2 Sekunden wieder l√∂schen (Aufr√§umen)
                setTimeout(() => steam.remove(), 2000);
            }
        }

        window.sendOrder = function() {
            createSteamEffect();
            const userName = currentUser ? currentUser.displayName : "Gast";
            const commentInput = document.getElementById('order-comment');
            const comment = commentInput ? commentInput.value.trim() : "";
            const statusDiv = document.getElementById('status');
            const sendBtn = document.querySelector('#order-modal .modal-btn');

            // Audio
            try {
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(500, audioCtx.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(1000, audioCtx.currentTime + 0.1);
                gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
                oscillator.start();
                oscillator.stop(audioCtx.currentTime + 0.5);
            } catch (e) { }

            let details = [];
            const strengthEl = document.getElementById('input-strength');
            if(strengthEl) details.push(`St√§rke ${strengthEl.value}`);
            
            const coffeeVolEl = document.getElementById('input-coffee-vol');
            if(coffeeVolEl) details.push(`${coffeeVolEl.value}ml Kaffee`);
            
            const milkVolEl = document.getElementById('input-milk-vol');
            if(milkVolEl) details.push(`${milkVolEl.value}ml Milch`);
            
            const totalVolEl = document.getElementById('input-total-vol');
            if(totalVolEl) details.push(`${totalVolEl.value}ml`);
            
            const cyclesEl = document.querySelector('input[name="cycles"]:checked');
            if(cyclesEl) details.push(cyclesEl.value);
            
            const vanillaEl = document.getElementById('extra-vanilla');
            if(vanillaEl && vanillaEl.checked) details.push("Vanille Sirup");
            
            const sweetEl = document.getElementById('extra-sweetener');
            if(sweetEl && sweetEl.checked) details.push("S√º√üstoff");

            let detailString = details.length > 0 ? ` (${details.join(', ')})` : "";
            let messageBody = `${userName} m√∂chte: ${currentCoffee.name}${detailString}`;
            if(comment) messageBody += `\nüí¨ "${comment}"`;

            sendBtn.innerText = "Sende...";

            push(ref(db, 'orders'), {
                user: userName,
                coffee: currentCoffee.name,
                details: details,
                comment: comment,
                timestamp: Date.now(),
                dateString: new Date().toLocaleString()
            });

            fetch(`https://ntfy.sh/${TOPIC_NAME}`, {
                method: 'POST',
                body: messageBody, 
                headers: { 'Title': 'Neue Bestellung', 'Priority': 'high', 'Tags': 'coffee' }
            })
            .then(response => {
                if (response.ok) {
                    orderModal.style.display = 'none';
                    document.getElementById('confirm-details').innerText = messageBody;
                    confirmModal.style.display = 'flex';
                    sendBtn.innerText = "Bestellen";
                } else { throw new Error('Send Error'); }
            })
            .catch(error => {
                sendBtn.innerText = "Bestellen";
                statusDiv.style.display = 'block';
                statusDiv.innerText = `‚ùå Fehler: ${error.message}`;
                setTimeout(() => statusDiv.style.display = 'none', 6000);
            });
        }

        // --- AGENT WERKZEUG: Letzte Bestellung finden ---
        async function repeatLastOrder() {
            if (!currentUser) return "Du musst eingeloggt sein!";

            // Wir holen die letzten 50 Bestellungen
            // (In einer echten Profi-App w√ºrde man das besser filtern, aber f√ºr Familie reicht das)
            const ordersRef = ref(db, 'orders');
            
            // Einmaliges Laden der Daten
            return new Promise((resolve) => {
                // Wir nutzen onValue einmalig (besser w√§re get(), aber wir haben den import schon)
                // Da wir 'onValue' schon importiert haben, nutzen wir einen Trick mit {onlyOnce: true} geht hier nicht einfach
                // Wir nutzen einfach onValue und bestellen es sofort wieder ab.
                
                const unsubscribe = onValue(ordersRef, (snapshot) => {
                    const data = snapshot.val();
                    unsubscribe(); // Sofort aufh√∂ren zu lauschen

                    if (!data) {
                        resolve("Ich habe keine alten Bestellungen gefunden.");
                        return;
                    }

                    // Alle Bestellungen in ein Array umwandeln
                    const orderList = Object.values(data);
                    
                    // Filtern nach meinem Namen
                    const myOrders = orderList.filter(o => o.user === currentUser.displayName);

                    if (myOrders.length === 0) {
                        resolve("Du hast hier noch nie bestellt!");
                        return;
                    }

                    // Die letzte Bestellung finden (h√∂chster Timestamp)
                    const lastOrder = myOrders.sort((a, b) => b.timestamp - a.timestamp)[0];

                    // --- JETZT BESTELLEN ---
                    // Wir setzen die globalen Variablen auf die Werte von damals
                    const coffeeName = lastOrder.coffee;
                    
                    // Wir suchen das Kaffe-Objekt in deiner Liste
                    const coffeeObj = kaffeeSorten.find(k => k.name === coffeeName);
                    
                    if (coffeeObj) {
                        currentCoffee = coffeeObj;
                        
                        // Hier tricksen wir: Wir f√ºllen das Kommentarfeld mit dem alten Kommentar
                        const commentInput = document.getElementById('order-comment');
                        if(commentInput) commentInput.value = lastOrder.comment || "";

                        // Und wir l√∂sen die Bestellung aus!
                        sendOrder(); 
                        resolve(`Ich habe deine letzte Bestellung (${lastOrder.coffee}) erneut aufgegeben!`);
                    } else {
                        resolve("Den Kaffee von damals gibt es nicht mehr.");
                    }
                });
            });
        }

        const chatWindow = document.getElementById('chat-window');
        const chatMessages = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');

        window.toggleChat = function() {
            if (chatWindow.style.display === 'flex') {
                chatWindow.style.display = 'none';
            } else {
                chatWindow.style.display = 'flex';
                setTimeout(() => chatInput.focus(), 100);
            }
        }

        window.handleEnter = function(e) {
            if (e.key === 'Enter') window.sendMessage();
        }

        window.sendMessage = async function() {
            const text = chatInput.value.trim();
            if (!text) return;
            addMessage(text, 'user-msg');
            chatInput.value = "";
            const loadingDiv = addMessage("Barista denkt nach...", 'bot-msg');
            
            try {
                const answer = await fetchGeminiResponse(text);
                loadingDiv.innerText = answer;
            } catch (error) {
                loadingDiv.innerText = "Sorry, Fehler.";
            }
        }

        function addMessage(text, className) {
            const div = document.createElement('div');
            div.className = `message ${className}`;
            div.innerText = text;
            chatMessages.appendChild(div);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            return div;
        }

        async function fetchGeminiResponse(userQuestion) {
            // 1. Pr√ºfen, ob Key da ist
            if (!GEMINI_API_KEY) return "Moment, ich lade noch meinen Schl√ºssel... Frag gleich nochmal!";

            const menuContext = kaffeeSorten.map(k => `- ${k.name}: ${k.desc} (St√§rke: ${k.strength}/5)`).join("\n");
            
            const prompt = `
                Du bist Timo, ein freundlicher Barista-KI-Agent.
                Hier ist unsere Karte:
                ${menuContext}
                
                User Name: ${currentUser ? currentUser.displayName : "Gast"}
                Frage: "${userQuestion}"
                
                Antworte auf Deutsch, kurz und charmant.
            `;
            
            // HIER IST DIE √ÑNDERUNG: Wir nehmen das Modell aus deinem Screenshot
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`;
            
            try {
                const response = await fetch(url, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                
                const data = await response.json();
                
                // Fehlerpr√ºfung
                if (data.error) {
                    return `Technik-Fehler: ${data.error.message}`;
                }

                if (data.candidates && data.candidates[0].content) {
                    let answer = data.candidates[0].content.parts[0].text.trim();
                    
                    // Agenten-Check f√ºr Nachbestellung
                    if (answer.includes("ACTION_REORDER")) {
                        addMessage("Moment, ich schaue ins Auftragsbuch... üìñ", 'bot-msg');
                        const resultText = await repeatLastOrder();
                        return resultText;
                    }

                    return answer;
                }
                
                return "Keine Antwort erhalten.";

            } catch (e) { return `Verbindungs-Fehler: ${e.message}`; }
        }

        // Init
        kaffeeSorten.forEach(sorte => {
            const btn = document.createElement('div');
            btn.className = 'coffee-card';
            btn.onclick = () => window.openOrderModal(sorte.name);
            
            let dots = "";
            if(sorte.strength > 0) {
                dots = '<span class="dots">';
                for(let i=1; i<=5; i++) dots += i<=sorte.strength ? '<span class="dot-filled">‚Ä¢</span>' : '<span class="dot-empty">‚Ä¢</span>';
                dots += '</span>';
                dots = `<div class="strength-container">ST√ÑRKE ${dots}</div>`;
            }
            btn.innerHTML = `<div class="name">${sorte.name}</div><div class="desc">${sorte.desc}</div>${dots}`;
            container.appendChild(btn);
        });

        function createSelect(id, label, options, suffix) {
            let html = `<div class="form-group"><label class="form-label">${label}</label>`;
            html += `<select id="${id}" class="modal-select">`;
            options.forEach(opt => html += `<option value="${opt}">${opt}${suffix}</option>`);
            html += `</select></div>`;
            return html;
        }

        // ============================================
        //   SCHNEE-LOGIK
        // ============================================
        function letItSnow() {
            const container = document.getElementById('snow-container');
            const numberOfFlakes = 50; // Anzahl der Schneeflocken

            for (let i = 0; i < numberOfFlakes; i++) {
                const flake = document.createElement('div');
                flake.classList.add('snowflake');
                
                // Zuf√§llige Position, Gr√∂√üe und Geschwindigkeit
                const xPos = Math.random() * 100; // 0 bis 100vw
                const size = Math.random() * 5 + 2; // 2px bis 7px gro√ü
                const duration = Math.random() * 5 + 3; // 3s bis 8s Fallzeit
                const delay = Math.random() * 5; // Startverz√∂gerung
                const opacity = Math.random() * 0.5 + 0.3; // Transparenz

                flake.style.left = `${xPos}vw`;
                flake.style.width = `${size}px`;
                flake.style.height = `${size}px`;
                flake.style.animationDuration = `${duration}s`;
                flake.style.animationDelay = `-${delay}s`; // Negativ, damit es sofort voll aussieht
                flake.style.opacity = opacity;

                container.appendChild(flake);
            }
        }

        // Schnee starten!
        letItSnow();
    </script>
    <div id="snow-container"></div>
</body>
</html>

















